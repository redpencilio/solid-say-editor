<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/block-handlers/edit-in-editor-block-handler.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/block-handlers/edit-in-editor-block-handler.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { inject as service } from '@ember/service';
import SolidHandler from "./block-handler";
import rdflib from "ember-rdflib";


const EDIT_EDITOR_KEY = "say-solid:edit-in-editor-block-handler";
export { EDIT_EDITOR_KEY };
const RDFS = rdflib.Namespace("http://www.w3.org/2000/01/rdf-schema#")

const { Statement } = rdflib;
/**
 * Handler class responsible for handling events coming from the dispatcher and for sending updates to the rdflib-store when data is edited in the editor
 *
 * @class EditInEditorBlockHandler
 * @extends SolidHandler
 * 
 * @property {ModelStoreCommunicatorService} store Store communicator
 */
export default class EditInEditorBlockHandler extends SolidHandler {

    @service("model/store-communicator") store;

    /**
     * 
     * this method is called when an rdfa-tag in the editor is edited, rdfa-tags are converted to rdflib.js-triples and stored in the local store
     * 
     * @param {string} hrId Hr id
     * @param {Block} block Context block
     * @param {HintsRegistry} hintsRegistry Hints registry
     * @param {Editor} editor editor
     * 
     * @memberof EditInEditorBlockHandler
     */
    handle(hrId, block, hintsRegistry, editor) {
        this.fromRDFa(block, block.context, editor);
    }


    /**
   * 
   * Save say-editor's context RDF statements in the local forking store as the user 
   * edit the texts in the editor.  
   * The saving is done by keeping track of the state changes on the local store, through 
   * the use of `add` statements and `remove` statements. 
   * 
   * @param {EditorBlock} block A logical blob for which the content may have changed. A blob
   * either has a different semantic meaning, or is logically separated (eg: a separate list item). 
   * See say-editor's `block` definition.
   * @param {Context[]} triples a list of say-editor's context statements {subject, predicate, object}. 
   * @param {Editor} editor say editor which will be used to manipulate domNodes. 
   * 
   * @memberof EditInEditorBlockHandler
   */
    fromRDFa(block, triples, editor) {
        triples.forEach(triple => {
            const replacementValue = (block.text) ? block.text.trim() : "";
            const originalObjectValue = this.extractUuid(block);
            if (triple.predicate !== "a" &amp;&amp; triple.subject !== "#") {
                const subjectNode = rdflib.sym(triple.subject);
                const graphNode = this.store.getGraph(subjectNode, this.store.getType(subjectNode, triples));
                const predicateNode = rdflib.sym(triple.predicate);
                let domAttrReplaceValObj = {
                    "attr": undefined,
                    "value": replacementValue
                }
                let rdfWrapper;

                if (triple.datatype === RDFS("Resource").value) {
                    domAttrReplaceValObj.attr = "resource";
                    rdfWrapper = rdflib.sym;
                } else {
                    domAttrReplaceValObj.attr = "content";
                    rdfWrapper = rdflib.literal;
                }
                // const oldQuad = { subjectNode, predicateNode, objectNode: rdfWrapper(triple.object.trim()), graphNode }
                const oldQuad = new Statement(subjectNode, predicateNode, rdfWrapper(triple.object.trim()), graphNode);

                let newObjectNode =
                    this.processNode(
                        block.semanticNode.domNode,
                        domAttrReplaceValObj,
                        rdfWrapper,
                        editor
                    );
                const newQuad = new Statement(subjectNode, predicateNode, newObjectNode, graphNode);

                this.store.updateQuad(oldQuad, newQuad, originalObjectValue);
            }
        });
    }




    /**
     * 
     * Method responsible for fetching the old quad that needs to be deleted from the store
     * This method also updates the content-attribute of a span tag, or the href-attribute of an a-tag to the new value.
     * 
     * @param {Statement} oldQuad The previous quad that needs to be deleted from the local store
     * @param {DomNode} domNode Dom-node that needs it's content- or href-attribute updated.
     * @param {Object} domAttrReplaceValObj Contains the attribute-key that needs to be updated, also contains the new attribute-value.
     * @param {String} domAttrReplaceValObj.attr the new attribute value.
     * @param rdfWrapper Responsible for creating a Resource-node or Literal-node, depending on the type of object.
     * @param {Editor} editor say editor which will be used to manipulate domNodes. 
     * 
     * @memberof EditInEditorBlockHandler
     */
    processNode(domNode, domAttrReplaceValObj, rdfWrapper, editor) {
        let updateObject = {}
        updateObject[domAttrReplaceValObj.attr] = domAttrReplaceValObj.value;
        editor.replaceDomNode(domNode, {
            callback: (domNode) => {
                if (domNode.hasAttribute(domAttrReplaceValObj.attr)) {
                    domNode.setAttribute(domAttrReplaceValObj.attr, domAttrReplaceValObj.value);
                }
            },

            failedCallback: (domNode, msg) => { console.log(`${domNode}\n ${msg}`) },
            motivation: "update (set) failed with nodesToWrap being undefined"
        })


        let newObjectNode = rdfWrapper(domAttrReplaceValObj.value);
        return newObjectNode;
    }


    /**
     * Gets the uuid of the attribute in the given logical block. 
     * The uuid is used to identify the correct attribute to update when typing in the editor. 
     * @param {EditorBlock} block A logical block from the editor containing the attribute, whose uuid will be extracted. 
     * 
     * @memberof EditInEditorBlockHandler
     */
    extractUuid(block) {
        if (block.richNode.length) {
            let attributes = block.richNode[0].parent.domNode.attributes;
            return attributes["data-uuid"] ? attributes["data-uuid"].value.trim() : undefined;
        }
    }

}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="EditInEditorBlockHandler.html">EditInEditorBlockHandler</a></li><li><a href="FetchBlockHandler.html">FetchBlockHandler</a></li><li><a href="File.html">File</a></li><li><a href="FileCreateModalComponent.html">FileCreateModalComponent</a></li><li><a href="FileListComponent.html">FileListComponent</a></li><li><a href="FilesBlockHandler.html">FilesBlockHandler</a></li><li><a href="FileSelectorComponent.html">FileSelectorComponent</a></li><li><a href="Folder.html">Folder</a></li><li><a href="Form.html">Form</a></li><li><a href="LoginBlockHandler.html">LoginBlockHandler</a></li><li><a href="LoginButtonComponent.html">LoginButtonComponent</a></li><li><a href="ModalComponent.html">ModalComponent</a></li><li><a href="ModalsVocabDropdownComponent.html">ModalsVocabDropdownComponent</a></li><li><a href="ModelSerializer.html">ModelSerializer</a></li><li><a href="ModelStoreCommunicatorService.html">ModelStoreCommunicatorService</a></li><li><a href="PredicateSelectorComponent.html">PredicateSelectorComponent</a></li><li><a href="ProfileHeaderComponent.html">ProfileHeaderComponent</a></li><li><a href="ProfileService.html">ProfileService</a></li><li><a href="RdfaEditorSaySolidPlugin.html">RdfaEditorSaySolidPlugin</a></li><li><a href="SaveResetBlockHandler.html">SaveResetBlockHandler</a></li><li><a href="SaySolidFetchCard.html">SaySolidFetchCard</a></li><li><a href="SaySolidFilesCard.html">SaySolidFilesCard</a></li><li><a href="SaySolidLoginCard.html">SaySolidLoginCard</a></li><li><a href="SaySolidSaveResetCard.html">SaySolidSaveResetCard</a></li><li><a href="SaySolidTypesCard.html">SaySolidTypesCard</a></li><li><a href="SolidBlockHandler.html">SolidBlockHandler</a></li><li><a href="SubjectCreateModalComponent.html">SubjectCreateModalComponent</a></li><li><a href="SubjectSelectorComponent.html">SubjectSelectorComponent</a></li><li><a href="TextBlockHandler.html">TextBlockHandler</a></li><li><a href="TripleCreateModalComponent.html">TripleCreateModalComponent</a></li><li><a href="TripleFormComponent.html">TripleFormComponent</a></li><li><a href="TypesBlockHandler.html">TypesBlockHandler</a></li><li><a href="TypeSelectorComponent.html">TypeSelectorComponent</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addObjectToUuidMap">addObjectToUuidMap</a></li><li><a href="global.html#fetchRemoteQuads">fetchRemoteQuads</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Thu Aug 13 2020 13:33:11 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
